# 商城功能实现方案

## 1. 目录结构设计

```
scenes/
├── mainScene/
│   └── main_scene.tscn    # 主场景，添加商城按钮
└── ui/
    └── shop/               # 商城相关UI
        ├── shop_popup.tscn # 商城弹窗场景
        └── shop_item.tscn  # 商品项场景（可选，用于复用）

scripts/
├── ui/
│   └── shop/
│       ├── shop_manager.gd    # 商城管理脚本
│       └── shop_popup.gd      # 商城弹窗脚本
└── data/
    └── shop_data.gd           # 商品数据管理
```

## 2. 核心实现方案

### 2.1 UI实现

#### 2.1.1 主场景修改
- 在主场景右下角添加商城按钮（Button节点）
- 按钮文本："商城"
- 按钮位置：右下角
- 字体大小：26

#### 2.1.2 商城弹窗设计
- **根节点**：Panel（带背景）
- **标题栏**：HBoxContainer
  - 标题文本："商城"
  - 关闭按钮：Button（右上角）
- **商品列表**：VBoxContainer
  - 每个商品项：HBoxContainer
    - 商品名称：Label
    - 价格：Label
    - 效果：Label
    - 购买按钮：Button

### 2.2 数据结构设计

#### 2.2.1 商品数据
```gdscript
# shop_data.gd
const SHOP_ITEMS = [
    {
        "id": "liuyang_zhengcai",
        "name": "浏阳蒸菜",
        "price": 15,
        "effect_type": "stamina",  # 效果类型：stamina（增加体力）, max_stamina（增加体力上限）
        "effect_value": 25,
        "description": "增加25点体力"
    },
    {
        "id": "protein_shake",
        "name": "蛋白质奶昔",
        "price": 30,
        "effect_type": "max_stamina",
        "effect_value": 10,
        "description": "增加10点体力上限"
    },
    {
        "id": "energy_bar",
        "name": "能量棒",
        "price": 8,
        "effect_type": "stamina",
        "effect_value": 15,
        "description": "增加15点体力"
    }
]
```

### 2.3 脚本逻辑设计

#### 2.3.1 商城管理器（shop_manager.gd）
- 单例设计，管理商城数据和购买逻辑
- 提供获取商品列表、购买商品等方法
- 与PlayerAttributes系统交互

#### 2.3.2 商城弹窗脚本（shop_popup.gd）
- 管理弹窗的显示/隐藏
- 动态生成商品列表
- 处理商品购买事件
- 与shop_manager交互

#### 2.3.3 主场景脚本修改
- 添加商城按钮点击事件处理
- 控制商城弹窗的显示/隐藏

### 2.4 交互逻辑

1. **显示商城**：
   - 点击主场景商城按钮 → 调用shop_popup.show()

2. **隐藏商城**：
   - 点击弹窗关闭按钮 → 调用shop_popup.hide()

3. **购买商品**：
   - 点击商品购买按钮 → 调用shop_manager.buy_item(item_id)
   - shop_manager检查金钱 → 消耗金钱 → 应用效果
   - 更新UI显示

## 3. 技术实现细节

### 3.1 UI节点类型
- **按钮**：Button
- **弹窗背景**：Panel
- **布局容器**：VBoxContainer, HBoxContainer
- **文本显示**：Label

### 3.2 脚本实现
- 使用GDScript编写
- 遵循现有项目的信号绑定方式
- 与PlayerAttributes单例交互
- 数据持久化（可选，保存购买记录）

### 3.3 效果应用
```gdscript
# 根据商品效果类型应用效果
match item.effect_type:
    "stamina":
        player_attributes.add_stamina(item.effect_value)
    "max_stamina":
        # 这里需要扩展PlayerAttributes，添加增加体力上限的方法
        player_attributes.increase_max_stamina(item.effect_value)
```

## 4. 实现步骤

1. **创建目录结构**
2. **实现商品数据管理（shop_data.gd）**
3. **创建商城弹窗场景（shop_popup.tscn）**
4. **实现商城弹窗脚本（shop_popup.gd）**
5. **实现商城管理器（shop_manager.gd）**
6. **修改主场景，添加商城按钮**
7. **修改主场景脚本，添加商城按钮点击事件**
8. **扩展PlayerAttributes，添加增加体力上限的方法（如果需要）**
9. **测试商城功能**

## 5. 注意事项

1. **UI布局**：使用Godot的容器节点进行灵活布局
2. **信号处理**：确保信号正确绑定和处理
3. **边界检查**：购买前检查金钱是否充足
4. **UI更新**：购买后及时更新UI显示
5. **性能优化**：商品列表动态生成，避免过多节点
6. **扩展性**：设计灵活的数据结构，便于添加新商品

## 6. 预期效果

- 主场景右下角显示商城按钮
- 点击按钮弹出商城弹窗
- 弹窗内显示商品列表，包含名称、价格、效果和购买按钮
- 点击购买按钮后消耗金钱，获得相应效果
- 弹窗右上角有关闭按钮，点击关闭弹窗
- UI实时更新，显示最新的金钱和体力值